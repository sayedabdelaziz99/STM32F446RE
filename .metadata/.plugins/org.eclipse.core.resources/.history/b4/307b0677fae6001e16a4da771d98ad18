/*
 * receive.c
 *
 *  Created on: Mar 20, 2024
 *      Author: Sayed
 */

#include "GPIO_driver.h"
#include "RCC_driver.h"
#include "bsp.h"
#include "string.h"
#include "Timer_Driver.h"
#include <stdio.h>

int main(void){
	GPIO_CAN1Init(GPIOA, GPIO_PIN_NO_11, 9);
	GPIO_CAN1Init(GPIOA, GPIO_PIN_NO_12, 9);
	GPIO_LEDInit();
	//enable the clock for the bus
	RCC ->APB1ENR |= (1 << RCC_APB1ENR_CAN1EN);
	//clear sleep bit in MCR
	CAN1 ->MCR &= ~(1U << 1);
	//initialize the CAN bus
	CAN1 ->MCR |= (1 << 0);
	//wait until CAN enters initialization mode
	while(! (CAN1 ->MSR & (1 << 0)));
	CAN1 ->BTR &= 0x00000000U;
	CAN1 ->BTR |= (1U << 24);//SWj
	CAN1 ->BTR |= (13U << 16);//seg1
	CAN1 ->BTR |= (2U << 20);//seg2
	CAN1 ->BTR |= (2U << 0);//BRP
	//configure the filter banks to accept all IDs
	//initialize the filter bank
	CAN1 ->FMR |= (1U << 0);
	//enable interrupt for pending messages on FIFO 0
	CAN1 ->IER |= (1U << 1);
	//enable NVIC interrupt for CAN RX (IRQ no. 20) ISER0;
	*ISER0 |= (1U << 20);
	//set it to MASK MODE
	CAN1 ->FM1R &= ~(1 << 0);
	//use single 32bit register
	CAN1 ->FS1R |= (1 << 0);
	//assign the message to FIFO 0
	CAN1 ->FFA1R &= ~(1U << 0);
	//set the ID in the filter bank
	CAN1 ->sFilterRegister[0].FR1 = 0x55U << 5;
	//set the MASK
	CAN1 ->sFilterRegister[0].FR2 = 0x7FFU << 5;
	//activate the filter
	CAN1 ->FMR &= ~(1U << 0);
	CAN1 ->FA1R |= (1U << 0);
	//enter normal mode
	CAN1 ->MCR &= ~(1 << 0);
	//wait until CAN is in normal mode
	while(CAN1 ->MSR & (1 << 0));
	while(1){

	}
}

void CAN1_RX0_IRQHandler(void){
	*ICPR |= (1U << 20);
	GPIO_ToggleOutputPin(GPIOA, GPIO_PIN_NO_5);
}
